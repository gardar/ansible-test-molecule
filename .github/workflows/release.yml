---
name: Release
on:
  pull_request_target:
    types:
      - closed

jobs:
  release:
    if: |
      github.event.pull_request.merged &&
      !contains(github.event.pull_request.labels.*.name, 'skip_changelog')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "Calculate next version"
        id: version
        uses: gardar/version-drafter-action@event-triggers  # Until PR gets merged: https://github.com/patrickjahns/version-drafter-action/pull/343
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: "Update version"
        run: |
          sed -i "s/^# Version:.*/# Version: ${VERSION}/" ansible-test-molecule.sh
        env:
          VERSION: "${{ steps.version.outputs.next-version }}"

      - name: "Write version"
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          branch: "${{ github.event.pull_request.base.ref }}"
          commit_message: "chore: update version"
          push_options: --force

      - name: "Checkout updated branch"
        uses: actions/checkout@v3
        with:
          ref: "${{ github.event.pull_request.base.ref }}"

      - name: "Publish release"
        id: release-publish
        uses: release-drafter/release-drafter@v5
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
